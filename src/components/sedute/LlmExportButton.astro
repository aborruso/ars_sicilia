---
import { getTranscriptTxtUrl } from '../../lib/constants';

interface Props {
  video: any;
  seduta: any;
  baseUrl?: string;
}

const { video, seduta, baseUrl = '/ars_sicilia' } = Astro.props;

// Generate export text block with LLM prompt
function generateExportText(): string {
  const dateStr = new Date(video.dataVideo).toLocaleDateString('it-IT', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });

  const duration = video.durationMinutes > 0 ? ` (${video.durationMinutes} minuti)` : '';

  // Build resource URLs
  let transcriptUrl = '';
  if (video.youtubeId) {
    transcriptUrl = getTranscriptTxtUrl(video.youtubeId);
  }

  let agendaUrl = seduta.odgUrl || '';

  const videoUrl = `https://www.youtube.com/watch?v=${video.youtubeId}`;

  // Build the prompt template
  let resourceList = '';
  if (transcriptUrl) {
    resourceList += `Trascrizione: ${transcriptUrl}\n\n`;
  }
  if (agendaUrl) {
    resourceList += `Ordine del giorno: ${agendaUrl}\n\n`;
  }
  resourceList += `Video: ${videoUrl}`;

  const text = `Analizza la seduta dell'Assemblea Regionale Siciliana indicata sotto usando tutte le risorse fornite (trascrizione, ordine del giorno e video).

Produci una sintesi chiara e comprensibile per le persone, in italiano semplice.

La sintesi deve:
- spiegare di cosa si √® parlato
- indicare le decisioni prese (se ci sono)
- segnalare temi rilevanti o controversi
- evitare linguaggio tecnico o burocratico

Se usi titoli o sezioni, usa sentence case italiano (es. "Temi principali", non "Temi Principali").

---

SEDUTA N. ${seduta.numero} | ${dateStr} | ORE ${video.oraVideo}${duration}

Risorse:

${resourceList}`;

  return text.trim();
}

const exportText = generateExportText();
const jsonUrl = `${baseUrl}/sedute/${seduta.yearMonthDay.year}/${seduta.yearMonthDay.month}/${seduta.yearMonthDay.day}/${seduta.slug}/${video.slug}.json`;
---

<div class="my-6">
  <div class="flex flex-wrap gap-3 items-center">
    <button
      id="llm-export-button"
      data-export-text={exportText}
      class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
      aria-label="Esporta risorse per assistente AI"
    >
      üìã Copia risorse per l'AI
    </button>
    <a
      href={jsonUrl}
      class="inline-flex items-center gap-2 px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors font-medium"
      title="Scarica risorsis in formato JSON per consumo machine-to-machine"
    >
      ‚öôÔ∏è JSON
    </a>
  </div>
  <div id="export-toast" class="hidden fixed bottom-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg"></div>
  <div id="export-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-2xl max-h-96 overflow-auto">
      <h3 class="text-lg font-bold mb-3">Risorse per LLM</h3>
      <pre class="whitespace-pre-wrap text-sm bg-gray-50 p-3 rounded border border-gray-200 mb-4">{exportText}</pre>
      <p class="text-sm text-gray-600 mb-4">Testo selezionato. Premi Ctrl+C per copiare se il bottone non ha funzionato.</p>
      <button
        id="modal-close-button"
        class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors"
      >
        Chiudi
      </button>
    </div>
  </div>
</div>

<script>
  const button = document.getElementById('llm-export-button');
  const toast = document.getElementById('export-toast');
  const modal = document.getElementById('export-modal');
  const modalClose = document.getElementById('modal-close-button');

  if (button) {
    button.addEventListener('click', async () => {
      const text = button.dataset.exportText || '';

      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(text);
          showToast('‚úì Risorse copiate negli appunti');
        } else {
          showModal(text);
        }
      } catch (err) {
        showModal(text);
      }
    });
  }

  if (modalClose) {
    modalClose.addEventListener('click', () => {
      if (modal) modal.classList.add('hidden');
    });
  }

  if (modal) {
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.classList.add('hidden');
      }
    });
  }

  function showToast(message: string) {
    if (toast) {
      toast.textContent = message;
      toast.classList.remove('hidden');
      setTimeout(() => {
        toast.classList.add('hidden');
      }, 3000);
    }
  }

  function showModal(text: string) {
    if (modal) {
      modal.classList.remove('hidden');
      const pre = modal.querySelector('pre');
      if (pre) {
        pre.textContent = text;
        pre.select?.();
        try {
          document.execCommand('copy');
        } catch (err) {
          console.error('Copy failed:', err);
        }
      }
    }
  }
</script>
