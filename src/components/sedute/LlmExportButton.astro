---
interface Props {
  video: any;
  seduta: any;
}

const { video, seduta } = Astro.props;

// Generate export text block
function generateExportText(): string {
  const dateStr = new Date(video.dataVideo).toLocaleDateString('it-IT', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });

  const duration = video.durationMinutes > 0 ? ` (${video.durationMinutes} minuti)` : '';

  // Transcript URL (if transcript exists)
  let transcriptLine = '';
  if (video.youtubeId) {
    transcriptLine = `ðŸ“š Trascrizione automatica:\nhttps://raw.githubusercontent.com/aborruso/ars_sicilia/main/data/trascrizioni/${video.youtubeId}.it.txt\n`;
  }

  // Agenda URL
  let agendaLine = '';
  if (seduta.odgUrl) {
    agendaLine = `ðŸ“„ Ordine del giorno seduta correlata:\n${seduta.odgUrl}\n`;
  }

  // YouTube link
  const youtubeLine = `ðŸŽ¬ Video YouTube:\nhttps://www.youtube.com/watch?v=${video.youtubeId}\n`;

  const text = `Seduta n. ${seduta.numero} | ${dateStr} | Ore ${video.oraVideo}${duration}

${transcriptLine}${agendaLine}${youtubeLine}`;

  return text.trim();
}

const exportText = generateExportText();
---

<div class="my-6">
  <button
    id="llm-export-button"
    data-export-text={exportText}
    class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
    aria-label="Esporta risorse per assistente AI"
  >
    ðŸ“‹ Copia risorse per LLM
  </button>
  <div id="export-toast" class="hidden fixed bottom-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg"></div>
  <div id="export-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-2xl max-h-96 overflow-auto">
      <h3 class="text-lg font-bold mb-3">Risorse per LLM</h3>
      <pre class="whitespace-pre-wrap text-sm bg-gray-50 p-3 rounded border border-gray-200 mb-4">{exportText}</pre>
      <p class="text-sm text-gray-600 mb-4">Testo selezionato. Premi Ctrl+C per copiare se il bottone non ha funzionato.</p>
      <button
        id="modal-close-button"
        class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors"
      >
        Chiudi
      </button>
    </div>
  </div>
</div>

<script>
  const button = document.getElementById('llm-export-button');
  const toast = document.getElementById('export-toast');
  const modal = document.getElementById('export-modal');
  const modalClose = document.getElementById('modal-close-button');

  if (button) {
    button.addEventListener('click', async () => {
      const text = button.dataset.exportText || '';

      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(text);
          showToast('âœ“ Risorse copiate negli appunti');
        } else {
          showModal(text);
        }
      } catch (err) {
        showModal(text);
      }
    });
  }

  if (modalClose) {
    modalClose.addEventListener('click', () => {
      if (modal) modal.classList.add('hidden');
    });
  }

  if (modal) {
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.classList.add('hidden');
      }
    });
  }

  function showToast(message: string) {
    if (toast) {
      toast.textContent = message;
      toast.classList.remove('hidden');
      setTimeout(() => {
        toast.classList.add('hidden');
      }, 3000);
    }
  }

  function showModal(text: string) {
    if (modal) {
      modal.classList.remove('hidden');
      const pre = modal.querySelector('pre');
      if (pre) {
        pre.textContent = text;
        pre.select?.();
        try {
          document.execCommand('copy');
        } catch (err) {
          console.error('Copy failed:', err);
        }
      }
    }
  }
</script>
