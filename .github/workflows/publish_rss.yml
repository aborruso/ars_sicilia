name: Publish RSS feed

on:
  schedule:
    - cron: "17 2 * * *" # daily 02:17 UTC
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  rss:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        env:
          VENV_PATH: /tmp/ars_venv
        run: |
          python -m venv "$VENV_PATH"
          . "$VENV_PATH/bin/activate"
          pip install -r requirements.txt

      - name: Generate RSS
        env:
          BASE_URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}
          VENV_PATH: /tmp/ars_venv
        run: |
          . "$VENV_PATH/bin/activate"
          python scripts/generate_rss.py \
            --base-url "$BASE_URL" \
            --limit 20 \
            --output feed.xml

      - name: Publish to gh-pages
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ ! -f feed.xml ]; then
            echo "feed.xml missing; RSS generation did not produce output"
            exit 1
          fi

          tmp_dir="$(mktemp -d)"
          cp feed.xml "$tmp_dir/feed.xml"

          gh auth setup-git
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"

          git fetch origin gh-pages || true
          if git show-ref --verify --quiet refs/remotes/origin/gh-pages; then
            git checkout gh-pages
            git reset --hard origin/gh-pages
          else
            git checkout --orphan gh-pages
            git rm -rf .
          fi

          # Preserva viewer/, rimuovi solo file root
          find . -maxdepth 1 -type f -not -name '.nojekyll' -delete
          rm -rf .venv
          find . -type d -name '__pycache__' -prune -exec rm -rf {} +
          find . -type f -name '*.pyc' -delete
          rm -rf public

          # Copia solo feed.xml preservando viewer/
          cp "$tmp_dir/feed.xml" ./feed.xml
          touch .nojekyll

          git add -A
          git commit -m "chore: update rss" || exit 0
          git push origin gh-pages

      - name: Enable Pages (idempotent)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api -X PUT repos/${{ github.repository }}/pages \
            -f source[branch]=gh-pages \
            -f source[path]=/ || true
