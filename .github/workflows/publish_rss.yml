name: Publish RSS feed

on:
  schedule:
    - cron: "17 2 * * *" # daily 02:17 UTC
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  rss:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m venv .venv
          . .venv/bin/activate
          pip install -r requirements.txt

      - name: Generate RSS
        env:
          BASE_URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}
        run: |
          . .venv/bin/activate
          python scripts/generate_rss.py \
            --base-url "$BASE_URL" \
            --limit 20 \
            --output public/feed.xml

      - name: Publish to gh-pages
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ ! -d public ]; then
            echo "public/ missing; RSS generation did not produce output"
            exit 1
          fi

          tmp_dir="$(mktemp -d)"
          cp -R public "$tmp_dir/public"

          gh auth setup-git
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"

          git fetch origin gh-pages || true
          if git show-ref --verify --quiet refs/remotes/origin/gh-pages; then
            git checkout gh-pages
            git reset --hard origin/gh-pages
          else
            git checkout --orphan gh-pages
            git rm -rf .
          fi

          rm -rf *
          cp -R "$tmp_dir/public/"* .
          touch .nojekyll

          git add -A
          git commit -m "chore: update rss" || exit 0
          git push origin gh-pages

      - name: Enable Pages (idempotent)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api -X PUT repos/${{ github.repository }}/pages \
            -f source[branch]=gh-pages \
            -f source[path]=/ || true
